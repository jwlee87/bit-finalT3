<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.coily.repository.dao.CardDAO">

	<resultMap id="cardMap" type="cardVO">
		<result property="cardNo" column="card_no"/>
		<result property="userNickName" column="user_nick_name"/>
		<result property="userNo" column="user_no"/>
		<result property="cardContent" column="card_content"/>
		<result property="cardRegDate" column="card_reg_date"/>
		<result property="fileGroupNo" column="file_group_no"/>
	</resultMap>
	
<!-- 			카드 리스트 		-->
<!-- ============================================================================== -->
	<select id="selectCard" parameterType="searchVO" resultMap="cardMap">
		select card_no,
			   user_no,
			   case when instr(CARD_CONTENT, "\n") = 0 then CARD_CONTENT
		 			when instr(CARD_CONTENT, "\n") = 1 then CARD_CONTENT
         			else left(CARD_CONTENT, instr(CARD_CONTENT, "\n")) 
         		end as card_content,
			   card_reg_date
		  from tb_card 
		    order by card_no desc
		    limit #{begin}, 5
	</select>
	
	<select id="selectCardCount" parameterType="searchVO" resultType="int">
		select count(*)
		from tb_card
	</select>
	
	<select id="selectOneCard" parameterType="int" resultMap="cardMap">
		select *
		from tb_card
		  where card_no= #{cardNo}
	</select>
	
	<select id="selectDetailCard" parameterType="int" resultMap="cardMap">
		select c.card_no, c.card_content, c.card_reg_date, u.user_no, u.user_nick_name  
		  from tb_card c, tb_user u
		 where c.user_no = u.user_no
		   and card_no= #{cardNo}
	</select>
	
	
<!-- ============================================================================== -->


<!-- 			카드 등록 			-->
<!-- ============================================================================== -->	
	<insert id="insertCard" parameterType="kr.co.coily.repository.vo.CardVO">
	
<!-- 		쿼리 등록			 -->
		insert into tb_card(
			user_no,
			card_content
		   )values(
			156,
			#{cardContent}
			)
			
		<selectKey keyProperty="cardNo" order="AFTER" resultType="int">
			select last_insert_id()
		</selectKey>
	</insert>
	
<!-- 	<insert id="insertFile" parameterType="kr.co.coily.repository.vo.CardVO">
				
		
		<selectKey keyProperty="cardNo" order="AFTER" resultType="int">
			select last_insert_id()
		</selectKey>
	</insert> -->
	
<!-- 			카드 등록 			-->
<!-- ============================================================================== -->
	
	
<!-- 			카드 수정 			-->
<!-- ============================================================================== -->
	
	 <update id="updateCard" parameterType="cardVO">
    	 update tb_card
    	   set card_content = #{cardContent}
    	 where card_no = #{cardNo}
    	   and user_no = #{userNo}
    </update>
	
	
	
<!-- 			카드 수정 			-->
<!-- ============================================================================== -->




<!-- 			카드 삭제 			-->
<!-- ============================================================================== -->
	<delete id="deleteCard">
		delete
		  from tb_card
		 where card_no = #{no}
	</delete>

<!-- 			카드 삭제 			-->
<!-- ============================================================================== -->





	<resultMap id="cardCommentMap" type="commentVO" >
		<result property="cardCommentNo" column="card_comment_no" />
		<result property="cardNo" column="card_no" />
		<result property="userNo" column="user_no" />
		<result property="cardCommentContent" column="card_comment_content" />
		<result property="cardCommentRegDate" column="card_comment_reg_date" />
	</resultMap>
<!-- 			댓글 조회 			-->
<!-- ============================================================================== -->
	
	<select id="selectCardCommentByNo" parameterType="int" resultMap="cardCommentMap">
	    select card_comment_no,
	           card_no,
	           user_no,
	           card_comment_content,
	           card_comment_reg_date
	      from tb_card_comment
	     where card_no = #{cardNo}     
	     order by card_comment_no 
	</select>

	<insert id="insertCardComment" parameterType="kr.co.coily.repository.vo.CommentVO">
		insert into tb_card_comment(
			 card_no,
			 user_no,
			 card_comment_content
		    )values(
			#{cardNo},
			156,
			#{cardCommentContent}
		)
		
		<selectKey keyProperty="cardNo" order="AFTER" resultType="int">
			select last_insert_id()
		</selectKey>
	</insert>

	


<!-- 			댓글 조회 			-->
<!-- ============================================================================== -->




<!-- 			댓글 수정 			-->
<!-- ============================================================================== -->
	<!-- <update id="updateCardComment" parameterType="commentVO">
	    update tb_card_comment
	       set card_content = #{cardContent}
	     where card_comment_no = #{cardCommentNo}
	</update> -->


<!-- 			댓글 수정 			-->
<!-- ============================================================================== -->






<!-- 			댓글 삭제 			-->
<!-- ============================================================================== -->
<!-- 	<delete id="deleteCardComment" parameterType="int">
	    delete 
	      from tb_card_comment
	     where card_comment_no = #{cardCommentNo}
	</delete> -->


<!-- 			댓글 삭제 			-->
<!-- ============================================================================== -->





</mapper>